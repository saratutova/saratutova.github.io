<!DOCTYPE html>
<html>
<head>
    <title>AR.js Basic Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.min.js"></script>
         <style>
         body {
             margin: 0;
             padding: 0;
             font-family: Arial, sans-serif;
             overflow: hidden;
             position: fixed;
             width: 100vw;
             height: 100vh;
         }
         
         /* Mobile-specific fixes */
         @media (max-width: 768px) {
             body {
                 position: fixed;
                 top: 0;
                 left: 0;
                 width: 100vw;
                 height: 100vh;
                 overflow: hidden;
             }
         }
         
                                                                                                                                                                                                                                                                                                                               /* AR.js video and canvas fixes */
              video, #arjs-video {
                  position: fixed !important;
                  top: 0 !important;
                  left: 0 !important;
                  width: 100vw !important;
                  height: 100vh !important;
                  object-fit: cover !important;
                  z-index: -2 !important;
                  margin: 0 !important;
                  padding: 0 !important;
              }
             
                           /* Mobile-specific video fixes */
              @media (max-width: 768px) {
                  video, #arjs-video {
                      object-fit: cover !important;
                      width: 100vw !important;
                      height: 100vh !important;
                      margin: 0 !important;
                      padding: 0 !important;
                  }
              }
         
                   .a-canvas {
              position: fixed !important;
              top: 0 !important;
              left: 0 !important;
              width: 100vw !important;
              height: 100vh !important;
              z-index: -1 !important;
          }
          
          /* Override any AR.js inline styles */
          video[style*="margin"], #arjs-video[style*="margin"] {
              margin: 0 !important;
          }
          
          video[style*="width"], #arjs-video[style*="width"] {
              width: 100vw !important;
          }
          
          video[style*="height"], #arjs-video[style*="height"] {
              height: 100vh !important;
          }
         
         #status {
             position: fixed;
             top: 20px;
             left: 20px;
             background: rgba(0, 0, 0, 0.7);
             color: white;
             padding: 10px;
             border-radius: 5px;
             z-index: 1000;
             font-size: 14px;
         }
         
         #instructions {
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: rgba(0, 0, 0, 0.8);
             color: white;
             padding: 20px;
             border-radius: 10px;
             text-align: center;
             z-index: 1000;
             max-width: 90vw;
         }
     </style>
</head>
<body>
    <div id="status">Camera: Initializing...</div>
    <div id="instructions">
        <h3>Krosno AR Experience</h3>
        <p>1. Allow camera access</p>
        <p>2. Point camera at Hiro marker</p>
        <p>3. You should see your 3D model</p>
        <p><a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/examples/marker-training/examples/pattern-files/pattern-hiro.png" target="_blank" style="color: #4ecdc4;">Download Hiro marker</a></p>
        <button onclick="this.parentElement.style.display='none'">Got it!</button>
    </div>

                   <a-scene
          vr-mode-ui="enabled: false"
          arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono;"
          embedded
          renderer="logarithmicDepthBuffer: true; antialias: true;">

        <!-- Assets -->
        <a-assets>
            <a-asset-item id="model" src="./models/7579_3K.glb"></a-asset-item>
        </a-assets>

        <a-marker preset="hiro">
            <a-entity 
                gltf-model="#model" 
                scale="0.1 0.1 0.1" 
                position="0 0 0"
                rotation="0 0 0">
            </a-entity>
            
            <!-- Enhanced lighting for the model -->
            <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
            <a-light type="directional" color="#ffffff" intensity="1.0" position="0 1 0"></a-light>
            <a-light type="directional" color="#ffffff" intensity="0.8" position="1 1 1"></a-light>
            <a-light type="directional" color="#ffffff" intensity="0.6" position="-1 1 -1"></a-light>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Basic AR.js setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Check for A-Frame
            if (typeof AFRAME !== 'undefined') {
                console.log('A-Frame loaded');
            } else {
                console.log('A-Frame not loaded');
            }
            
            // Check for AR.js
            if (typeof ARjs !== 'undefined') {
                console.log('AR.js loaded');
            } else {
                console.log('AR.js not loaded');
            }
            
            // Check if AR.js script loaded
            const scripts = document.querySelectorAll('script');
            let arjsScriptFound = false;
            scripts.forEach(script => {
                if (script.src && script.src.includes('ar.js')) {
                    console.log('AR.js script found:', script.src);
                    arjsScriptFound = true;
                }
            });
            
            if (!arjsScriptFound) {
                console.log('AR.js script not found in page');
            }
        });

        // AR.js events
        document.addEventListener('arjs-loaded', function() {
            console.log('AR.js loaded event fired');
            document.getElementById('status').textContent = 'Camera: AR.js Ready';
        });

        document.addEventListener('camera-init', function() {
            console.log('Camera init event fired');
            document.getElementById('status').textContent = 'Camera: Initialized';
        });

        document.addEventListener('camera-error', function(error) {
            console.error('Camera error event fired:', error);
            document.getElementById('status').textContent = 'Camera: Error';
        });

        // Marker events
        document.addEventListener('DOMContentLoaded', function() {
            const marker = document.querySelector('a-marker');
            if (marker) {
                console.log('Marker element found');
                
                marker.addEventListener('markerFound', function() {
                    console.log('Marker found!');
                    document.getElementById('status').textContent = 'Marker: Found!';
                    document.getElementById('status').style.background = 'rgba(0, 255, 0, 0.7)';
                });

                marker.addEventListener('markerLost', function() {
                    console.log('Marker lost');
                    document.getElementById('status').textContent = 'Camera: Ready';
                    document.getElementById('status').style.background = 'rgba(0, 0, 0, 0.7)';
                });
            } else {
                console.log('Marker element not found');
            }
        });

                 // Check for video element periodically
         function checkVideo() {
             const video = document.querySelector('video') || document.querySelector('#arjs-video');
             if (video) {
                 console.log('Video element found:', video);
                 console.log('Video readyState:', video.readyState);
                 document.getElementById('status').textContent = 'Camera: Video found';
                 
                 // Force video to fill entire screen (both desktop and mobile)
                 console.log('Applying full-screen video fixes');
                 
                                   // Remove any margins or padding that might be causing white space
                  video.style.position = 'fixed';
                  video.style.top = '0';
                  video.style.left = '0';
                  video.style.width = '100vw';
                  video.style.height = '100vh';
                  video.style.objectFit = 'cover';
                  video.style.zIndex = '-2';
                  video.style.margin = '0';
                  video.style.padding = '0';
                  video.style.transform = 'none';
                  
                  // Ensure video covers the full screen without distortion
                  video.addEventListener('loadedmetadata', function() {
                      console.log('Video metadata loaded, dimensions:', video.videoWidth, 'x', video.videoHeight);
                      video.style.objectFit = 'cover';
                      video.style.width = '100vw';
                      video.style.height = '100vh';
                      video.style.margin = '0';
                      video.style.padding = '0';
                  });
                 
                 return true;
             } else {
                 console.log('No video element found yet');
                 return false;
             }
         }

        // Check every second for 10 seconds
        let videoCheckCount = 0;
        const videoCheckInterval = setInterval(function() {
            videoCheckCount++;
            if (checkVideo() || videoCheckCount >= 10) {
                clearInterval(videoCheckInterval);
            }
        }, 1000);

        // Model loading debugging
        document.addEventListener('model-loaded', function(e) {
            console.log('Model loaded successfully:', e.detail);
            
            // Fix model materials to ensure visibility without destroying textures
            setTimeout(function() {
                const modelEntity = document.querySelector('[gltf-model="#model"]');
                if (modelEntity && modelEntity.object3D) {
                    console.log('Fixing model materials...');
                    
                    // Traverse all children and fix materials
                    modelEntity.object3D.traverse(function(child) {
                        if (child.material) {
                            console.log('Found material:', child.material);
                            
                            // Only fix visibility issues, preserve textures
                            child.material.transparent = false;
                            child.material.opacity = 1.0;
                            child.material.needsUpdate = true;
                            
                            // Don't override colors - preserve original textures
                            // Only fix if the material is completely black
                            if (child.material.color && 
                                child.material.color.r === 0 && 
                                child.material.color.g === 0 && 
                                child.material.color.b === 0) {
                                console.log('Found black material, applying default color');
                                child.material.color.setHex(0xcccccc); // Light gray instead of white
                            }
                            
                            // Ensure proper lighting for MeshStandardMaterial
                            if (child.material.type === 'MeshStandardMaterial') {
                                // Only set if not already set
                                if (child.material.metalness === undefined || child.material.metalness === 1.0) {
                                    child.material.metalness = 0.0;
                                }
                                if (child.material.roughness === undefined || child.material.roughness === 0.0) {
                                    child.material.roughness = 0.5;
                                }
                            }
                        }
                    });
                    
                    console.log('Model materials fixed (textures preserved)');
                }
            }, 1000);
        });

        document.addEventListener('model-error', function(e) {
            console.error('Model failed to load:', e.detail);
        });

                 // Handle mobile orientation changes
         window.addEventListener('orientationchange', function() {
             console.log('Orientation changed');
             setTimeout(function() {
                                   // Re-apply video fixes after orientation change (cover entire screen)
                  const video = document.querySelector('video') || document.querySelector('#arjs-video');
                  if (video) {
                      video.style.position = 'fixed';
                      video.style.top = '0';
                      video.style.left = '0';
                      video.style.width = '100vw';
                      video.style.height = '100vh';
                      video.style.objectFit = 'cover';
                      video.style.zIndex = '-2';
                      video.style.margin = '0';
                      video.style.padding = '0';
                      video.style.transform = 'none';
                  }
             }, 500);
         });
        
        // Check HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert('AR requires HTTPS. Please access via HTTPS or localhost.');
        }
    </script>
</body>
</html> 